#!/bin/bash
#
# Wait for the results of an SPI execution.
# Receives the image_unique_id of the execution.
# Exits with:
# - 0 if the test passed.
# - 1 if the test failed.
# - 2 if it timed out checking for results.

readonly TIMEOUT=7200  # 2 hours.
readonly WAIT=900  # 15 minutes.
results="[]"

function get_results() {
  echo "Checking for results."
  url="http://result-enumerator.spi.canonical.com/orgs/canonical/results?image_unique_id="$@""
  results="$(curl --silent "${url}" | jq '.test_results')"
}

time=0
get_results "$@"
while [[ "${results}" = "[]" ]]; do
  if [[ "${time}" -lt "${TIMEOUT}" ]]; then
    echo "Results not found. Sleeping to try again later."
    sleep ${WAIT}
    time+="${WAIT}"
    get_results "$@"
  else
    echo "Timed out waiting for results."
    exit 2
  fi
done

status="$(echo "${results}" | jq ".[0].test_status")"
echo "${status}"
if [[ "${status}" = "\"PASSED\"" ]]; then
  exit 0
else
  exit 1
fi
